language: "typescript"
tags:
  - "tsdown-build"

tasks:
  check:
    script: "deno fmt --check && deno lint && deno check src/**/*.ts"
    toolchains:
      - "deno"
    deps:
      - "vocab:codegen"
    inputs:
      - "src/**/*"
      - "/mise.toml"
    options:
      cache: true

  build:
    script: "pnpm exec tsdown"
    toolchains:
      - "node"
    deps:
      - "^:build"
    inputs:
      - "src/**/*"
      - "tsdown.config.ts"
      - "/mise.toml"
    outputs:
      - "dist/"
    options:
      cache: true

  test.deno:
    command: "deno test --check --doc --allow-read --allow-write --allow-env --unstable-kv --trace-leaks --parallel"
    toolchains:
      - "deno"
    deps:
      - "vocab:codegen"
    inputs:
      - "src/**/*"
      - "/mise.toml"
    options:
      cache: true

  test.node:
    script: "cd dist/ && node --test"
    toolchains:
      - "node"
    deps:
      - "~:build"
    inputs:
      - "src/**/*"
      - "dist/**/*"
      - "/mise.toml"
    options:
      cache: true

  test.bun:
    script: "cd dist/ && bun test --timeout 60000"
    toolchains:
      - "bun"
    deps:
      - "~:build"
    inputs:
      - "src/**/*"
      - "dist/**/*"
      - "/mise.toml"
    options:
      cache: true

  test.cfworkers:
    script: "pnpm exec wrangler deploy --dry-run --outdir src/cfworkers && node --import=tsx src/cfworkers/client.ts"
    toolchains:
      - "node"
    deps:
      - "~:build"
    inputs:
      - "src/**/*"
      - "wrangler.toml"
      - "/mise.toml"

  coverage:
    script: "deno test --check --doc --allow-read --allow-write --allow-env --unstable-kv --trace-leaks --parallel --clean --coverage && deno coverage --html coverage"
    toolchains:
      - "deno"
    deps:
      - "~:build"
    inputs:
      - "src/**/*"
      - "/mise.toml"
    outputs:
      - "coverage/"

  bench:
    command: "deno bench --allow-read --allow-write --allow-net --allow-env --allow-run --unstable-kv"
    toolchains:
      - "deno"
    deps:
      - "~:build"
    inputs:
      - "src/**/*"
      - "/mise.toml"

  apidoc:
    command: "deno doc --html --name=Fedify --output=apidoc/ src/mod.ts"
    toolchains:
      - "deno"
    deps:
      - "~:build"
    inputs:
      - "src/**/*"
      - "/mise.toml"
    outputs:
      - "apidoc/"
